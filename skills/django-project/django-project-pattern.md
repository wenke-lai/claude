# Django Project Scaffold Pattern

**Prerequisite:** A Python environment (uv, ruff, pytest) must already exist. If not, skip this skill.

## 1. Add Django Dependencies

```bash
uv add django django-ninja django-environ django-cors-headers gunicorn
uv add --dev pytest-django
```

## 2. Create Django Project

Use `server` as the project directory name:

```bash
uv run django-admin startproject server .
mkdir -p apps
touch apps/__init__.py
```

## 3. .gitignore

Append Django-specific entries:

```
# Static files (collected)
staticfiles/
```

## 4. .env.example

```
SECRET_KEY=change-me-to-a-random-secret-key
DEBUG=True
DATABASE_URL=sqlite:///db.sqlite3
ALLOWED_HOSTS=localhost
CORS_ALLOWED_ORIGINS=http://localhost:8000,http://localhost:3000
CSRF_TRUSTED_ORIGINS=http://localhost:8000,http://localhost:3000
```

Copy `.env.example` to `.env`. Add `.env` to `.gitignore`.

## 5. server/settings.py

### django-environ

```python
import environ

env = environ.Env(
    DEBUG=(bool, False),
)
environ.Env.read_env(".env")

SECRET_KEY = env("SECRET_KEY")
DEBUG = env("DEBUG")
ALLOWED_HOSTS = env.list("ALLOWED_HOSTS", default=[])

DATABASES = {
    "default": env.db(),
}

CORS_ALLOWED_ORIGINS = env.list("CORS_ALLOWED_ORIGINS", default=[])
CSRF_TRUSTED_ORIGINS = env.list("CSRF_TRUSTED_ORIGINS", default=[])
```

Remove the original `SECRET_KEY`, `DEBUG`, `DATABASES`, and `ALLOWED_HOSTS` assignments generated by Django.

### INSTALLED_APPS

```python
INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    # Third-party
    "corsheaders",
    # Applications
    "apps.users",
]
```

### MIDDLEWARE

Add `"corsheaders.middleware.CorsMiddleware"` before `"django.middleware.common.CommonMiddleware"`.

### CACHE_CONTROL

```python
CACHE_CONTROL = {
    "public": True,
    "max_age": 60 * 5,
    "stale_while_revalidate": 60 * 5,
    "stale_if_error": 60 * 60 * 24,
}
```

### Static Files

```python
STATIC_URL = "static/"
STATICFILES_DIRS = [BASE_DIR / "static"]
STATIC_ROOT = BASE_DIR / "staticfiles"
```

### Auth

```python
AUTH_USER_MODEL = "users.User"
```

## 6. server/apis.py

```python
from django.core.exceptions import MultipleObjectsReturned, ObjectDoesNotExist
from django.shortcuts import redirect
from ninja import NinjaAPI

api = NinjaAPI()


def index(request):
    return redirect("/api/docs")


@api.exception_handler(ObjectDoesNotExist)
def object_does_not_exist(request, exc):
    return api.create_response(request, {"detail": str(exc)}, status=404)


@api.exception_handler(MultipleObjectsReturned)
def multiple_objects_returned(request, exc):
    return api.create_response(request, {"detail": str(exc)}, status=409)
```

## 7. server/urls.py

```python
from django.contrib import admin
from django.urls import path

from .apis import api, index

urlpatterns = [
    path("", index),
    path("admin/", admin.site.urls),
    path("api/", api.urls),
]
```

## 8. Users App

```bash
uv run python manage.py startapp users apps/users
```

### apps/users/apps.py

```python
from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.users"
    label = "users"
```

### apps/users/models.py

```python
from django.contrib.auth.models import AbstractUser


class User(AbstractUser):
    pass
```

### apps/users/admin.py

```python
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin

from .models import User


@admin.register(User)
class CustomUserAdmin(UserAdmin):
    pass
```

### apps/users/tests.py

```python
import pytest
from django.contrib.auth import get_user_model

User = get_user_model()


@pytest.mark.django_db
def test_create_user():
    user = User.objects.create_user(username="testuser", password="testpass123")
    assert user.username == "testuser"
    assert user.check_password("testpass123")
    assert user.is_active
    assert not user.is_staff
    assert not user.is_superuser


@pytest.mark.django_db
def test_create_superuser():
    user = User.objects.create_superuser(username="admin", password="adminpass123")
    assert user.is_active
    assert user.is_staff
    assert user.is_superuser


@pytest.mark.django_db
def test_user_str():
    user = User.objects.create_user(username="testuser", password="testpass123")
    assert str(user) == "testuser"
```

## 9. Static Directory

```bash
mkdir -p static
touch static/.gitkeep
```

## 10. pyproject.toml

Append Django-specific pytest config (replaces base pytest config if exists):

```toml
[tool.pytest.ini_options]
DJANGO_SETTINGS_MODULE = "server.settings"
pythonpath = ["."]
```

## 11. Makefile

Append Django-specific targets to the existing Makefile:

```makefile
dev: ## Start development server
	$(PYTHON) python manage.py runserver

preview: ## Preview with gunicorn
	$(PYTHON) python manage.py collectstatic --noinput
	$(PYTHON) gunicorn server.wsgi:application --bind 0.0.0.0:8000

migrate: ## Run database migrations
	$(PYTHON) python manage.py migrate

makemigrations: ## Create new migrations
	$(PYTHON) python manage.py makemigrations

shell: ## Open Django shell
	$(PYTHON) python manage.py shell
```

## 12. Run Migrations

```bash
uv run python manage.py makemigrations
uv run python manage.py migrate
```

## 13. Verify

```bash
make format
make test
```

## Expected Directory Structure

```
{project_name}/
├── .env
├── .env.example
├── apps/
│   ├── __init__.py
│   └── users/
│       ├── __init__.py
│       ├── admin.py
│       ├── apps.py
│       ├── migrations/
│       │   └── __init__.py
│       ├── models.py
│       ├── tests.py
│       └── views.py
├── server/
│   ├── __init__.py
│   ├── apis.py
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── static/
│   └── .gitkeep
├── manage.py
├── Makefile
└── pyproject.toml
```
